<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src {{cspSource}}; script-src 'nonce-{{nonce}}'; img-src {{cspSource}} https:; media-src {{cspSource}};">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="{{highlight_css_uri}}">
    <link href="{{chat_css_uri}}" rel="stylesheet">
    
    <script src="{{diff_js_uri}}" nonce="{{nonce}}"></script>
    
    <title>Ä°vme Chat</title>
</head>
<body data-ai-icon-uri="{{ai_icon_uri}}" data-user-icon-uri="{{user_icon_uri}}">
    <div id="icon-uris" data-edit-icon="{{edit_icon_uri}}" data-apply-icon="{{apply_icon_uri}}" data-insert-icon="{{insert_icon_uri}}" data-tool-code-icon="{{tool_code_icon_uri}}" style="display:none"></div>
    
    <video autoplay muted loop id="background-video" src="{{welcome_video_uri}}"></video>

    <div class="main-content-wrapper">
        <header class="chat-header">
            <button id="logo-button" class="header-logo-title" title="GeliÅŸtirme Paketi Sunumunu GÃ¶ster">
                <img src="{{logo_uri}}" alt="Logo" class="header-logo"/>
                <span>Ä°vme</span>
            </button>
            <div class="header-actions">

                <div class="language-toggle">
                    <input type="checkbox" id="language-toggle" />
                    <label for="language-toggle" class="toggle-bubble">
                        <span class="lang-option tr">TR</span>
                        <span class="lang-option en">EN</span>
                    </label>
                </div>

                <button id="history-button" class="icon-button" title="KonuÅŸma GeÃ§miÅŸi">
                    <img src="{{history_icon_uri}}" alt="KonuÅŸma GeÃ§miÅŸi"/>
                </button>
                <button id="new-chat-button" class="icon-button" title="Yeni KonuÅŸma">
                    <img src="{{new_chat_icon_uri}}" alt="Yeni KonuÅŸma"/>
                </button>
                <!-- Eski header indeks butonu kaldÄ±rÄ±ldÄ± -->
                <button id="feedback-button" class="icon-button" title="Geri Bildirim">
                    <img src="{{feedback_icon_uri}}" alt="Geri Bildirim"/>
                </button>
                <button id="settings-button" class="icon-button" title="Ayarlar">
                    <img src="{{settings_icon_uri}}" alt="Ayarlar"/>
                </button>
            </div>
            
            <div id="history-panel" class="history-panel hidden">
                <div id="history-list-container" class="history-list-container"></div>
            </div>

        </header>

        <div id="welcome-container">
            <div class="welcome-box">
                <img src="{{logo_uri}}" alt="Ä°vme Logo" id="welcome-logo"/>
                <h1>Ä°vme</h1>
                <p id="welcome-subtitle">Kod geliÅŸtirme ve analiz sÃ¼reÃ§lerinizi yapay zeka ile hÄ±zlandÄ±rÄ±n.</p>
            </div>
        </div>

        <div id="chat-container" class="hidden"></div>
        
        <div id="file-context-area"></div>
        <!-- Planner panel: input baloncuÄŸunun hemen Ã¼zerinde gÃ¶sterilecek uzun ince panel -->
        <div id="planner-panel" class="planner-panel hidden collapsed">
            <div class="planner-panel-bar">
                <div class="planner-panel-title">Plan AdÄ±mlarÄ±</div>
                <button id="planner-panel-toggle" class="icon-button" title="AÃ§/Kapa" aria-label="AÃ§/Kapa">
                    <!-- basit chevron ikonu -->
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
            <div id="planner-panel-content" class="planner-panel-content hidden">
                <ol id="planner-steps-list" class="planner-steps-list"></ol>
            </div>
        </div>

        <div id="language-warning" class="language-warning">Daha iyi sonuÃ§lar iÃ§in "EN" mod Ã¶nerilir.</div>


        <div class="input-area">
            <div class="input-wrapper">
                <!-- Yeni: indeksleme overlay log alanÄ± -->
                <div id="indexer-overlay-log" class="indexer-overlay-log hidden"></div>
                <textarea id="prompt-input" rows="1" placeholder="ivmeye soru sorun..."></textarea>
                <div class="input-actions-bar">
                    <div class="action-group-left">

                        <button id="attach-file-button" title="Dosya Ekle">
                            <img src="{{attach_icon_uri}}" alt="Dosya Ekle" />
                        </button>

                        <div class="mode-switch" id="mode-switch">
                            <button id="agent-mode-button" class="mode-button" aria-haspopup="true" aria-expanded="false" title="Mod DeÄŸiÅŸtir">
                                <span class="mode-label">Chat</span>
                                <svg class="mode-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <div id="agent-mode-menu" class="mode-menu hidden" role="menu" aria-hidden="true">
                                <button class="mode-menu-item" data-mode="chat" role="menuitem">Chat</button>
                                <button class="mode-menu-item" data-mode="agent" role="menuitem">Agent</button>
                            </div>
                        </div>

                        <!-- Yeni: Agent mod aktifken gÃ¶rÃ¼necek indeksleme butonlarÄ± -->
                        <button id="indexer-start-button" class="hidden" title="Projeyi Ä°ndeksle" aria-label="Projeyi Ä°ndeksle">
                            <img src="{{index_icon_uri}}" alt="Ä°ndeksle" class="index-icon"/>
                        </button>
                        <button id="indexer-cancel-button" class="hidden" title="Durdur" aria-label="Durdur"></button>

                        <button id="agent-status-collapsed" class="icon-button hidden" title="Agent baÄŸlamÄ±nÄ± gÃ¶ster">
                            <img src="{{agent_icon_uri}}" class="agent-status-icon" alt="Agent"/>
                        </button>
                        <div id="agent-status-bar" class="agent-status-bar hidden" title="Aktif baÄŸlam">
                            <img src="{{agent_icon_uri}}" class="agent-status-icon" alt="Agent Aktif"/>
                            <span id="agent-status-text"></span>
                            <button id="agent-status-hide" class="remove-selection-button" title="BaÄŸlamÄ± gizle">Ã—</button>
                        </div>

                    </div>
                    <div class="action-group-right">
                        <div id="plan-act-toggle" class="plan-act-toggle hidden" role="switch" aria-checked="false" title="Plan/Act">
                            <input type="checkbox" id="plan-act-switch" />
                            <label for="plan-act-switch" class="toggle-bubble">
                                <span class="plan-option plan">Plan</span>
                                <span class="plan-option act">Act</span>
                            </label>
                        </div>
                        <div id="character-counter" class="character-counter">
                            <div class="token-progress-ring" data-tooltip="ðŸ“Š Token KullanÄ±mÄ±&#10;0 / 12000 tokens (0%)&#10;&#10;ðŸ“‹ Detay:&#10;â€¢ KonuÅŸma: 0 tokens&#10;â€¢ Dosyalar: 0 tokens&#10;â€¢ Prompt: 0 tokens&#10;â€¢ Kalan: 12000 tokens">
                                <svg viewBox="0 0 36 36">
                                    <circle class="progress-bg" cx="18" cy="18" r="16"></circle>
                                    <circle class="progress-fill" cx="18" cy="18" r="16" stroke-dasharray="0 100"></circle>
                                </svg>
                                <span class="percentage-text">0%</span>
                            </div>
                        </div>
                        
                        <button id="send-button" title="GÃ¶nder">
                            <img src="{{send_icon_uri}}" alt="GÃ¶nder" class="send-icon"/>
                            <svg class="stop-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" width="16" height="16">
                                <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                            </svg>
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </div> 
    
    <!-- Yeni: AdÄ±m JSON modalÄ± (minimal, dÃ¼zenlenebilir) -->
    <div id="step-json-modal" class="modal-overlay hidden">
        <div class="modal-content step-json-modal-content">
            <div class="modal-header step-json-modal-header">
                <h2 id="step-json-title">AdÄ±m JSON</h2>
                <div class="modal-actions">
                    <button id="save-step-json" class="primary-button">Kaydet</button>
                    <button id="close-step-json" class="secondary-button">Kapat</button>
                </div>
            </div>
            <div class="modal-main-content step-json-modal-body">
                <textarea id="step-json-editor" spellcheck="false"></textarea>
            </div>
        </div>
    </div>

    <!-- Yeni: Tool Code modalÄ± (custom tool kodunu gÃ¶rÃ¼ntÃ¼le/dÃ¼zenle) -->
    <div id="tool-code-modal" class="modal-overlay hidden">
        <div class="modal-content tool-code-modal-content">
            <div class="modal-header tool-code-modal-header">
                <h2 id="tool-code-title">Tool Kodu</h2>
                <div class="modal-actions">
                    <button id="save-tool-code" class="primary-button">Kaydet</button>
                    <button id="close-tool-code" class="secondary-button">Kapat</button>
                </div>
            </div>
            <div class="modal-main-content tool-code-modal-body">
                <textarea id="tool-code-editor" spellcheck="false"></textarea>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-sidebar">
                <div class="modal-header"><h2>Ayarlar</h2></div>
                <ul class="modal-nav">
                    <li><button class="nav-button active" data-target="pane-services">Servisler</button></li>
                    <li><button class="nav-button" data-target="pane-interface">ArayÃ¼z</button></li>
                    <li><button class="nav-button" data-target="pane-general">Genel</button></li>
                    <li><button class="nav-button" data-target="pane-tools">AraÃ§lar</button></li>
                </ul>
            </div>
            <div class="modal-main-content">
                <form id="settings-form">
                    <div id="pane-services" class="settings-pane active">
                        <div class="form-group"><label for="service-select">Aktif Servis</label><select id="service-select"><option value="vLLM">vLLM</option><option value="Gemini">Gemini</option></select></div>
                        <div id="vllm-settings">
                            <div class="form-group">
                                <label for="vllm-url">vLLM Sunucu Adresi</label>
                                <input type="text" id="vllm-url" placeholder="http://localhost:8000/v1">
                                <p id="vllm-connection-error" class="form-group-error hidden"></p>
                            </div>
                            <div class="form-group">
                                <label for="vllm-model">vLLM Model AdÄ±</label>
                                <input type="text" id="vllm-model" placeholder="Qwen/Qwen1.5-7B-Chat">
                            </div>
                        </div>                      
                        <div id="gemini-settings" class="hidden"><div class="form-group"><label for="gemini-key">Gemini API AnahtarÄ±</label><input type="password" id="gemini-key" placeholder="API AnahtarÄ±nÄ±zÄ± girin"></div></div>
                    </div>
                    <div id="pane-interface" class="settings-pane">
                        <div class="form-group form-group-toggle">
                            <div class="toggle-label-group">
                                <label for="video-toggle-switch">Arka Plan Videosu</label>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="video-toggle-switch" checked>
                                <span class="slider round"></span>
                            </label>
                            <p class="form-group-description">KarÅŸÄ±lama ekranÄ±nda oynatÄ±lan arka plan videosunu aÃ§ar veya kapatÄ±r.</p>
                        </div>
                    </div>
                    <div id="pane-general" class="settings-pane">
                        <div class="form-group"><label for="history-limit">KonuÅŸma GeÃ§miÅŸi Limiti</label><input type="number" id="history-limit" min="0" placeholder="2"><p class="form-group-description">Sohbete gÃ¶nderilecek Ã¶nceki mesaj sayÄ±sÄ±. Modelin baÄŸlamÄ± hatÄ±rlamasÄ± iÃ§in kullanÄ±lÄ±r.</p></div>
                        <div class="form-group"><label for="token-limit">Token Limiti</label><input type="number" id="token-limit" min="1000" max="50000" placeholder="12000"><p class="form-group-description">Maksimum token sayÄ±sÄ±. Bu limit aÅŸÄ±ldÄ±ÄŸÄ±nda yeni mesaj gÃ¶nderilemez.</p></div>
                        <div class="form-group">
                            <label for="temperature">SÄ±caklÄ±k (Temperature)</label>
                            <input type="range" id="temperature" min="0" max="2" step="0.1">
                            <p id="temperature-label" class="form-group-description">0.7</p>
                        </div>
                    </div>
                    <div id="pane-tools" class="settings-pane">
                        <div class="tools-container">
                            <h3>Mevcut AraÃ§lar</h3>
                            <p class="tools-description">Sistemde kullanÄ±labilir araÃ§lar ve aÃ§Ä±klamalarÄ±:</p>
                            <div class="tools-table">
                                <div class="tools-table-header">
                                    <div class="tool-name-header">AraÃ§ AdÄ±</div>
                                    <div class="tool-description-header">AÃ§Ä±klama</div>
                                    <div class="tool-actions-header">Ä°ÅŸlemler</div>
                                </div>
                                <div class="tools-table-body" id="tools-table-body">
                                    <!-- Tools will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="tools-actions">
                                <button type="button" id="add-tool-button" class="primary-button">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
                                    </svg>
                                    Yeni AraÃ§ Ekle
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions"><button type="button" id="cancel-settings-button" class="secondary-button">Ä°ptal</button><button type="submit" class="primary-button">Kaydet</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tool Creator Modal -->
    <div id="tool-creator-modal" class="modal-overlay hidden">
        <div class="modal-content tool-creator-modal-content">
            <div class="tool-creator-header">
                <h2>Yeni AraÃ§ OluÅŸtur</h2>
                <button type="button" id="close-tool-creator" class="close-button">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.75.75 0 1 1 1.06 1.06L9.06 8l3.22 3.22a.75.75 0 1 1-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 0 1-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06z"/>
                    </svg>
                </button>
            </div>
            <div class="tool-creator-body">
                <form id="tool-creator-form">
                    <div class="form-group">
                        <label for="tool-name">AraÃ§ AdÄ±</label>
                        <input type="text" id="tool-name" placeholder="Ã¶rn: send_email" required>
                        <p class="form-group-description">AraÃ§ adÄ± snake_case formatÄ±nda olmalÄ± (kÃ¼Ã§Ã¼k harf, alt Ã§izgi)</p>
                    </div>
                    <div class="form-group">
                        <label for="tool-description">AÃ§Ä±klama</label>
                        <textarea id="tool-description" rows="3" placeholder="Bu araÃ§ ne yapar? DetaylÄ± aÃ§Ä±klama yazÄ±n..." required></textarea>
                        <p class="form-group-description">AracÄ±n ne iÅŸe yaradÄ±ÄŸÄ±nÄ± ve nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± aÃ§Ä±klayÄ±n</p>
                    </div>
                    <div class="form-group">
                        <label for="tool-functionality">Ä°stenen Ä°ÅŸlevsellik</label>
                        <textarea id="tool-functionality" rows="4" placeholder="Bu araÃ§ hangi iÅŸlemleri yapmalÄ±? Hangi parametreleri almalÄ±? NasÄ±l Ã§alÄ±ÅŸmalÄ±?" required></textarea>
                        <p class="form-group-description">AracÄ±n teknik gereksinimlerini ve beklenen davranÄ±ÅŸÄ±nÄ± detaylÄ± ÅŸekilde aÃ§Ä±klayÄ±n</p>
                    </div>
                    <div class="tool-creator-actions">
                        <button type="button" id="cancel-tool-creator" class="secondary-button">Ä°ptal</button>
                        <button type="submit" class="primary-button">AraÃ§ OluÅŸtur</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <template id="message-template">
        <div class="message">
            <div class="avatar-wrapper">
                <img class="avatar-icon" src="" alt="Avatar">
            </div>
            <div class="message-content">
            </div>
        </div>
    </template>

    <template id="history-card-template">
        <div class="history-card" role="button" tabindex="0">
            <div class="history-meta">
                <div class="history-title"></div>
                <div class="history-snippet"></div>
            </div>
            <div class="history-right">
                <div class="history-time"></div>
                <button class="delete-chat-button" title="Sohbeti Sil" aria-label="Sohbeti sil">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" width="14" height="14"><path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.75.75 0 1 1 1.06 1.06L9.06 8l3.22 3.22a.75.75 0 1 1-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 0 1-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06z"/></svg>
                </button>
            </div>
        </div>
    </template>

    <script src="{{marked_js_uri}}" nonce="{{nonce}}"></script>
    <script src="{{highlight_js_uri}}" nonce="{{nonce}}"></script>
    
    <script type="module" src="{{chat_js_uri}}" nonce="{{nonce}}" data-agent-icon-uri="{{agent_icon_uri}}"></script>
</body>
</html>